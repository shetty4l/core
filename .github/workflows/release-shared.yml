name: Release (shared)

on:
  workflow_call:
    inputs:
      service-name:
        description: "Service name for tarball prefix and release title (e.g. engram, synapse)"
        required: true
        type: string
      extra-tarball-paths:
        description: "Space-separated additional paths to include in tarball (e.g. 'opencode/ scripts/install.sh')"
        required: false
        type: string
        default: ""
      publish-npm:
        description: "Whether to publish to GitHub Packages via npm publish"
        required: false
        type: boolean
        default: false
      attach-install-sh:
        description: "Whether to attach scripts/install.sh as a release asset"
        required: false
        type: boolean
        default: false

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Compute next version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
          echo "latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"

          VERSION="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          COMMITS_SINCE="$(git log "${LATEST_TAG}..HEAD" --format='%s' 2>/dev/null || echo "")"
          if echo "$COMMITS_SINCE" | grep -q '\[major\]'; then
            NEXT_VERSION="$((MAJOR + 1)).0.0"
            BUMP_LEVEL="major"
          elif echo "$COMMITS_SINCE" | grep -q '\[minor\]'; then
            NEXT_VERSION="${MAJOR}.$((MINOR + 1)).0"
            BUMP_LEVEL="minor"
          else
            NEXT_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
            BUMP_LEVEL="patch"
          fi

          echo "bump_level=${BUMP_LEVEL}" >> "$GITHUB_OUTPUT"
          echo "next_version=${NEXT_VERSION}" >> "$GITHUB_OUTPUT"
          echo "next_tag=v${NEXT_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Releasing: v${NEXT_VERSION} (previous: ${LATEST_TAG}, bump: ${BUMP_LEVEL})"

      - name: Write VERSION file
        run: echo "${{ steps.version.outputs.next_version }}" > VERSION

      - name: Update package.json version
        run: |
          jq --arg v "${{ steps.version.outputs.next_version }}" '.version = $v' package.json > tmp.json
          mv tmp.json package.json

      - name: Write BUILD_META.json
        run: |
          SHA="${{ github.event.workflow_run.head_sha }}"
          SHORT_SHA="${SHA:0:7}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          TITLE="$(git log -1 --format='%s' "$SHA")"
          BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          jq -n \
            --arg sha "$SHA" \
            --arg shortSha "$SHORT_SHA" \
            --arg branch "$BRANCH" \
            --arg title "$TITLE" \
            --arg buildTime "$BUILD_TIME" \
            '{
              gitSha: $sha,
              gitShortSha: $shortSha,
              gitBranch: $branch,
              commitTitle: $title,
              buildTimeUtc: $buildTime
            }' > BUILD_META.json

      - name: Publish to GitHub Packages
        if: ${{ inputs.publish-npm }}
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ github.token }}" > .npmrc
          echo "@shetty4l:registry=https://npm.pkg.github.com" >> .npmrc
          npm publish --access public

      - name: Create source tarball
        run: |
          TAG="${{ steps.version.outputs.next_tag }}"
          EXTRA_PATHS="${{ inputs.extra-tarball-paths }}"
          tar czf "${{ inputs.service-name }}-${TAG}.tar.gz" \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='test' \
            --exclude='.husky' \
            --exclude='.DS_Store' \
            --exclude='dist' \
            src/ \
            package.json \
            bun.lock \
            tsconfig.json \
            biome.json \
            VERSION \
            BUILD_META.json \
            $EXTRA_PATHS

      - name: Create tag and release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.version.outputs.next_tag }}"
          ASSETS=("${{ inputs.service-name }}-${TAG}.tar.gz")

          if [ "${{ inputs.attach-install-sh }}" = "true" ] && [ -f "scripts/install.sh" ]; then
            ASSETS+=("scripts/install.sh")
          fi

          git tag "${TAG}"
          git push origin "${TAG}"

          gh release create "${TAG}" \
            --title "Release ${TAG}" \
            --notes "Automated release ${TAG}" \
            "${ASSETS[@]}"
